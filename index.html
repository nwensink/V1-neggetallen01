<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekenen met Negatieve Getallen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Initialisatie
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'negatieve-getallen-app';

        let userName = "";
        let currentQuestionIndex = 0;
        let score = 0;
        let questions = [];
        const TOTAL_QUESTIONS = 10;
        const ADMIN_PASSWORD = "meester-check";

        // Auth initialisatie voor Firestore toegang
        const initAuth = async () => {
          if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
          } else {
            await signInAnonymously(auth);
          }
        };
        initAuth();

        function generateNumber(isDecimal) {
            let num = (Math.random() * 200 - 100);
            return isDecimal ? Math.round(num * 10) / 10 : Math.round(num);
        }

        function generateQuestions() {
            const qs = [];
            const decimalIndices = new Set();
            while(decimalIndices.size < 3) {
                decimalIndices.add(Math.floor(Math.random() * TOTAL_QUESTIONS));
            }

            for (let i = 0; i < TOTAL_QUESTIONS; i++) {
                const isDecimal = decimalIndices.has(i);
                let a = generateNumber(isDecimal);
                let b = generateNumber(isDecimal);

                if (a >= 0 && b >= 0) {
                    if (Math.random() > 0.5) a = -Math.abs(a || 1);
                    else b = -Math.abs(b || 1);
                }

                const operator = Math.random() > 0.5 ? '+' : '-';
                const correctAnswer = operator === '+' ? a + b : a - b;

                let aDisp = a.toString().replace('.', ',');
                let bDisp = b.toString().replace('.', ',');
                let latex = `${aDisp} ${operator} ${bDisp} = `;

                qs.push({
                    latex,
                    answer: Math.round(correctAnswer * 10) / 10
                });
            }
            return qs;
        }

        async function saveScore(finalScore) {
            if (!auth.currentUser) return;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'scores'), {
                    name: userName,
                    score: finalScore,
                    timestamp: new Date().toISOString()
                });
            } catch (e) { console.error(e); }
        }

        window.startApp = async () => {
            const nameInput = document.getElementById('nameInput').value.trim();
            if (!nameInput) return;
            userName = nameInput;
            
            questions = generateQuestions();
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            showQuestion();
        };

        function showQuestion() {
            const q = questions[currentQuestionIndex];
            document.getElementById('question-container').innerHTML = `<div class="text-3xl md:text-5xl">$$\\huge ${q.latex}$$</div>`;
            MathJax.typeset();
            
            const input = document.getElementById('answerInput');
            input.value = '';
            input.disabled = false;
            document.getElementById('feedback-overlay').classList.add('hidden');
            document.getElementById('checkBtn').classList.remove('hidden');
            input.focus();
            
            document.getElementById('progress').innerText = `Vraag ${currentQuestionIndex + 1} van ${TOTAL_QUESTIONS}`;
        }

        window.checkAnswer = () => {
            const inputEl = document.getElementById('answerInput');
            const userAns = parseFloat(inputEl.value.replace(',', '.'));
            const q = questions[currentQuestionIndex];
            const overlay = document.getElementById('feedback-overlay');
            const statusText = document.getElementById('status-text');
            
            if (isNaN(userAns)) return;

            inputEl.disabled = true;
            document.getElementById('checkBtn').classList.add('hidden');

            const isCorrect = Math.abs(userAns - q.answer) < 0.01;
            if (isCorrect) {
                score++;
                statusText.innerText = "GOED!";
                statusText.className = "text-4xl font-black text-green-500 animate-bounce";
            } else {
                statusText.innerText = "FOUT";
                statusText.className = "text-4xl font-black text-red-500";
            }

            overlay.classList.remove('hidden');

            setTimeout(() => {
                currentQuestionIndex++;
                if (currentQuestionIndex < TOTAL_QUESTIONS) {
                    showQuestion();
                } else {
                    showResults();
                }
            }, 1200);
        };

        window.handleKey = (e) => {
            if (e.key === 'Enter' && !document.getElementById('answerInput').disabled) {
                checkAnswer();
            }
        };

        function showResults() {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('end-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = `${userName}, je score is ${score} / ${TOTAL_QUESTIONS}`;
            
            if (score === 10) {
                confetti({
                    particleCount: 150,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }
            saveScore(score);
        }

        window.toggleAdmin = () => {
            const pw = prompt("Wachtwoord:");
            if (pw === ADMIN_PASSWORD) {
                showAdminPanel();
            } else if (pw !== null) {
                alert("Onjuist wachtwoord");
            }
        };

        async function showAdminPanel() {
            const panel = document.getElementById('admin-panel');
            panel.classList.toggle('hidden');
            if (!panel.classList.contains('hidden')) {
                const list = document.getElementById('scores-list');
                list.innerHTML = "<p class='p-4 text-center'>Resultaten laden...</p>";
                
                try {
                    const querySnapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'scores'));
                    let results = [];
                    querySnapshot.forEach(doc => results.push(doc.data()));
                    
                    if (results.length === 0) {
                        list.innerHTML = "<p class='p-4 text-center text-slate-400'>Nog geen resultaten gevonden.</p>";
                        return;
                    }

                    results.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    let html = '<table class="w-full text-left mt-2 text-xs border-collapse"><thead><tr class="border-b bg-slate-50"><th class="p-2">Naam</th><th class="p-2 text-center">Score</th><th class="p-2">Datum</th></tr></thead><tbody>';
                    results.forEach(d => {
                        const date = new Date(d.timestamp).toLocaleDateString('nl-NL', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                        html += `<tr class="border-b hover:bg-slate-50"><td class="p-2 font-medium">${d.name}</td><td class="p-2 text-center">${d.score}/10</td><td class="p-2 text-slate-500">${date}</td></tr>`;
                    });
                    list.innerHTML = html + '</tbody></table>';
                } catch (err) {
                    list.innerHTML = `<p class="p-4 text-red-500 text-center">Fout bij laden: ${err.message}</p>`;
                }
            }
        }
    </script>
    <style>
        .card {
            background: white;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 95%;
        }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* Custom scrollbar voor admin lijst */
        #scores-list::-webkit-scrollbar { width: 6px; }
        #scores-list::-webkit-scrollbar-track { background: #f1f1f1; }
        #scores-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-indigo-50 min-h-screen flex flex-col items-center justify-center p-4 font-sans text-slate-800">

    <div id="start-screen" class="card text-center">
        <h1 class="text-3xl font-black mb-6 text-indigo-600">Negatieve Getallen Trainer</h1>
        <p class="mb-6 text-slate-500">Oefen het optellen en aftrekken met negatieve getallen.</p>
        <input type="text" id="nameInput" placeholder="Wat is je naam?" class="w-full p-4 border-2 rounded-xl mb-6 text-xl focus:border-indigo-500 outline-none text-center">
        <button onclick="startApp()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold text-xl hover:bg-indigo-700 transition transform hover:scale-[1.02]">Starten</button>
    </div>

    <div id="game-screen" class="card hidden relative overflow-hidden text-center">
        <div id="progress" class="font-bold text-indigo-400 mb-6 tracking-widest uppercase text-sm"></div>
        <div id="question-container" class="mb-10 flex items-center justify-center min-h-[120px]"></div>
        <div class="relative max-w-md mx-auto">
            <input type="text" inputmode="decimal" id="answerInput" onkeydown="handleKey(event)" placeholder="?" 
                   class="w-full p-6 border-4 border-slate-100 rounded-2xl text-4xl text-center focus:border-indigo-300 outline-none transition-all">
            <div id="feedback-overlay" class="absolute inset-0 bg-white/90 flex items-center justify-center rounded-2xl hidden">
                <span id="status-text"></span>
            </div>
        </div>
        <button id="checkBtn" onclick="checkAnswer()" class="mt-8 w-full max-w-md mx-auto block bg-slate-800 text-white py-4 rounded-xl font-bold text-lg hover:bg-slate-900 transition">Bevestig (Enter)</button>
    </div>

    <div id="end-screen" class="card text-center hidden">
        <h2 class="text-4xl font-black mb-4">Klaar!</h2>
        <p id="final-score" class="text-2xl mb-8 text-indigo-600 font-medium"></p>
        <button onclick="location.reload()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold text-xl hover:bg-indigo-700 transition">Nog een keer</button>
    </div>

    <!-- Beheer Sectie -->
    <div class="mt-8 flex flex-col items-center w-full max-w-2xl">
        <button onclick="toggleAdmin()" class="text-slate-300 hover:text-indigo-400 text-[10px] uppercase tracking-tighter transition-colors mb-4">Beheer</button>
        
        <div id="admin-panel" class="card hidden w-full !p-6">
            <div class="flex justify-between items-center border-b pb-4 mb-2">
                <h3 class="font-black text-indigo-600 uppercase tracking-wide">Resultatenoverzicht</h3>
                <button onclick="document.getElementById('admin-panel').classList.add('hidden')" class="text-slate-400 hover:text-red-500 font-bold px-2">&times;</button>
            </div>
            <div id="scores-list" class="max-h-80 overflow-y-auto rounded-lg border border-slate-100">
                <!-- Resultaten tabel -->
            </div>
        </div>
    </div>

</body>
</html>