<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekenen met Negatieve Getallen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        /**
         * BELANGRIJK VOOR GITHUB:
         * De variabelen __firebase_config en __app_id werken alleen binnen deze omgeving.
         * Om de app op GitHub te laten werken, moet je hieronder je eigen Firebase gegevens invullen.
         */
        
        let firebaseConfig;
        let appId;

        try {
            // Probeer eerst de omgevingsvariabelen (voor Canvas)
            firebaseConfig = JSON.parse(__firebase_config);
            appId = typeof __app_id !== 'undefined' ? __app_id : 'negatieve-getallen-app';
        } catch (e) {
            // FALLBACK VOOR GITHUB:
            // Vul hieronder je eigen gegevens in die je van Firebase krijgt:
            firebaseConfig = {
      apiKey: "AIzaSyBXSOveWMEcrE-vGf9FreT4rF-pmw6d9Ak",

  authDomain: "neggetallen01.firebaseapp.com",

  projectId: "neggetallen01",

  storageBucket: "neggetallen01.firebasestorage.app",

  messagingSenderId: "475152363257",

  appId: "1:475152363257:web:a3f24114082f10bc093c28",

  measurementId: "G-Z3WL6F9VTV"
            };
            appId = "negatieve-getallen-app";
            console.log("Gebruik handmatige configuratie voor GitHub");
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userName = "";
        let currentQuestionIndex = 0;
        let score = 0;
        let questions = [];
        const TOTAL_QUESTIONS = 10;
        const ADMIN_PASSWORD = "meester-check";

        // Authenticatie op de achtergrond - blokkeert de UI niet
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                console.log("Database verbinding gereed");
            } catch (err) {
                console.warn("Database verbinding vertraagd of handmatige config nodig.");
            }
        };

        initAuth();

        function generateNumber(isDecimal) {
            let num = (Math.random() * 200 - 100);
            return isDecimal ? Math.round(num * 10) / 10 : Math.round(num);
        }

        function generateQuestions() {
            const qs = [];
            const decimalIndices = new Set();
            while(decimalIndices.size < 3) {
                decimalIndices.add(Math.floor(Math.random() * TOTAL_QUESTIONS));
            }

            for (let i = 0; i < TOTAL_QUESTIONS; i++) {
                const isDecimal = decimalIndices.has(i);
                let a = generateNumber(isDecimal);
                let b = generateNumber(isDecimal);

                if (a >= 0 && b >= 0) {
                    if (Math.random() > 0.5) a = -Math.abs(a || 1);
                    else b = -Math.abs(b || 1);
                }

                const operator = Math.random() > 0.5 ? '+' : '-';
                const correctAnswer = operator === '+' ? a + b : a - b;

                let aDisp = a.toString().replace('.', ',');
                let bDisp = b.toString().replace('.', ',');
                let latex = `${aDisp} ${operator} ${bDisp} = `;

                qs.push({
                    latex,
                    answer: Math.round(correctAnswer * 10) / 10
                });
            }
            return qs;
        }

        async function saveScore(finalScore) {
            if (!auth.currentUser) return;
            try {
                // Let op de pad-structuur voor Firebase regels
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'scores'), {
                    name: userName,
                    score: finalScore,
                    timestamp: new Date().toISOString()
                });
            } catch (e) { console.error(e); }
        }

        window.startApp = () => {
            const nameInput = document.getElementById('nameInput');
            const nameValue = nameInput.value.trim();
            
            if (!nameValue) {
                alert("Vul eerst je naam in.");
                return;
            }
            
            userName = nameValue;
            questions = generateQuestions();
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            showQuestion();
        };

        function showQuestion() {
            const q = questions[currentQuestionIndex];
            document.getElementById('question-container').innerHTML = `<div class="text-3xl md:text-5xl">$$\\huge ${q.latex}$$</div>`;
            if (window.MathJax && MathJax.typesetPromise) {
                MathJax.typesetPromise();
            }
            
            const input = document.getElementById('answerInput');
            input.value = '';
            input.disabled = false;
            document.getElementById('feedback-overlay').classList.add('hidden');
            document.getElementById('checkBtn').classList.remove('hidden');
            input.focus();
            
            document.getElementById('progress').innerText = `Vraag ${currentQuestionIndex + 1} van ${TOTAL_QUESTIONS}`;
        }

        window.checkAnswer = () => {
            const inputEl = document.getElementById('answerInput');
            const val = inputEl.value.replace(',', '.');
            if (val === "" || isNaN(parseFloat(val))) return;
            
            const userAns = parseFloat(val);
            const q = questions[currentQuestionIndex];
            const overlay = document.getElementById('feedback-overlay');
            const statusText = document.getElementById('status-text');
            
            inputEl.disabled = true;
            document.getElementById('checkBtn').classList.add('hidden');

            const isCorrect = Math.abs(userAns - q.answer) < 0.01;
            if (isCorrect) {
                score++;
                statusText.innerText = "GOED!";
                statusText.className = "text-4xl font-black text-green-500 animate-bounce";
            } else {
                statusText.innerText = "FOUT";
                statusText.className = "text-4xl font-black text-red-500";
            }

            overlay.classList.remove('hidden');

            setTimeout(() => {
                currentQuestionIndex++;
                if (currentQuestionIndex < TOTAL_QUESTIONS) {
                    showQuestion();
                } else {
                    showResults();
                }
            }, 1200);
        };

        window.handleKey = (e) => {
            if (e.key === 'Enter' && !document.getElementById('answerInput').disabled) {
                checkAnswer();
            }
        };

        function showResults() {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('end-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = `${userName}, je score is ${score} / ${TOTAL_QUESTIONS}`;
            
            if (score === TOTAL_QUESTIONS) {
                confetti({
                    particleCount: 150,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }
            saveScore(score);
        }

        window.toggleAdmin = () => {
            const pw = prompt("Wachtwoord:");
            if (pw === ADMIN_PASSWORD) {
                showAdminPanel();
            } else if (pw !== null) {
                alert("Onjuist wachtwoord.");
            }
        };

        async function showAdminPanel() {
            const panel = document.getElementById('admin-panel');
            panel.classList.toggle('hidden');
            if (!panel.classList.contains('hidden')) {
                const list = document.getElementById('scores-list');
                list.innerHTML = "Laden...";
                try {
                    const querySnapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'scores'));
                    let results = [];
                    querySnapshot.forEach(doc => results.push(doc.data()));
                    results.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    let html = '<table class="w-full text-left mt-2 text-xs border-collapse"><thead><tr class="border-b"><th>Naam</th><th>Score</th><th>Tijd</th></tr></thead><tbody>';
                    results.forEach(d => {
                        const datum = new Date(d.timestamp).toLocaleDateString('nl-NL');
                        html += `<tr class="border-b hover:bg-slate-50"><td class="py-1">${d.name}</td><td>${d.score}/10</td><td>${datum}</td></tr>`;
                    });
                    list.innerHTML = html + '</tbody></table>';
                } catch (e) {
                    list.innerHTML = "Fout bij laden.";
                }
            }
        }
    </script>
    <style>
        .card {
            background: white;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 95%;
        }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-indigo-50 min-h-screen flex flex-col items-center justify-center p-4 font-sans text-slate-800">

    <div id="start-screen" class="card text-center">
        <h1 class="text-3xl font-black mb-6 text-indigo-600">Negatieve Getallen Trainer</h1>
        <p class="mb-6 text-slate-500 text-lg">Oefen het rekenen met negatieve en decimale getallen.</p>
        <input type="text" id="nameInput" placeholder="Wat is je naam?" class="w-full p-4 border-2 rounded-xl mb-6 text-xl focus:border-indigo-500 outline-none text-center">
        <button onclick="startApp()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold text-xl hover:bg-indigo-700 transition transform hover:scale-[1.02]">Starten</button>
    </div>

    <div id="game-screen" class="card hidden relative overflow-hidden">
        <div id="progress" class="text-center font-bold text-indigo-400 mb-6 tracking-widest uppercase text-sm"></div>
        <div id="question-container" class="mb-10 text-center flex items-center justify-center min-h-[120px]"></div>
        <div class="relative max-w-md mx-auto">
            <input type="text" inputmode="decimal" id="answerInput" onkeydown="handleKey(event)" placeholder="?" 
                   class="w-full p-6 border-4 border-slate-100 rounded-2xl text-4xl text-center focus:border-indigo-300 outline-none transition-all">
            <div id="feedback-overlay" class="absolute inset-0 bg-white/90 flex items-center justify-center rounded-2xl hidden">
                <span id="status-text"></span>
            </div>
        </div>
        <button id="checkBtn" onclick="checkAnswer()" class="mt-8 w-full max-w-md mx-auto block bg-slate-800 text-white py-4 rounded-xl font-bold text-lg hover:bg-slate-900 transition">Bevestig (Enter)</button>
    </div>

    <div id="end-screen" class="card text-center hidden">
        <h2 class="text-4xl font-black mb-4">Klaar!</h2>
        <p id="final-score" class="text-2xl mb-8 text-indigo-600 font-medium"></p>
        <button onclick="location.reload()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold text-xl hover:bg-indigo-700 transition">Nog een keer</button>
    </div>

    <button onclick="toggleAdmin()" class="mt-8 text-slate-300 hover:text-slate-400 text-[10px] uppercase tracking-tighter transition-colors">Beheer</button>
    <div id="admin-panel" class="card mt-4 hidden">
        <h3 class="font-bold border-b pb-2">Resultaten</h3>
        <div id="scores-list" class="max-h-60 overflow-y-auto mt-2 text-sm"></div>
    </div>

</body>
</html>